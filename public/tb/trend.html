<script type="text/javascript">
  tb.trend =
  {
    table_name: "trend",

    Trend: function ()
    {
      this.id = null;
      this.query_id = null;
      this.datetime = null;
      this.count = null;
    },

    Select_Obj: function (db, id, on_success_fn)
    {
      tb.data.Select_Obj(db, "/" + this.table_name + "/" + id, on_success_fn);
    },

    Select_By_Query_Id: function (db, query_id, on_success_fn)
    {
      db.conn.ref("/" + this.table_name).orderByChild("query_id").equalTo(query_id).once("value", OK_Fn);
      function OK_Fn(query_res)
      {
        tb.data.To_Array(query_res, on_success_fn);
      }
    },

    Select_Chart_Vals_By_Query_Id: function (db, query_id, on_success_fn)
    {
      var key;

      key = "Select_Chart_Vals_By_Query_Id." + query_id;
      db.If_Not_In_Cache(key, Get_Vals, on_success_fn);
      function Get_Vals()
      {
        tb.trend.Select_By_Query_Id(db, query_id, Select_OK);
        function Select_OK(items)
        {
          var c, datetime, item_vals, item, vals;

          if (!tb.Empty(items))
          {
            vals = [];
            vals.push(['Date', 'Jobs']);
            for (c = 0; c < items.length; c++)
            {
              item = items[c];
              item_vals = [new Date(item.datetime), item.count];
              vals.push(item_vals);
            }
          }

          db.Insert_In_Cache(key, vals);
          on_success_fn(vals);
        }
      }
    },

    Insert: function (db, obj, on_success_fn)
    {
      obj.id = db.conn.ref("/" + this.table_name).push().key;
      db.conn.ref("/" + this.table_name + "/" + obj.id).set(obj, on_success_fn);
    },

    Insert_From_Query: function (db, query, on_success_fn)
    {
      tb.indeed.Get_Job_Count(query.terms, Get_Job_Count_OK);
      function Get_Job_Count_OK(count)
      {
        var trend;

        trend =
        {
          query_id: query.id,
          datetime: Date.now(),
          count: count
        };
        tb.trend.Insert(db, trend, on_success_fn);
      }
    },

    Insert_From_Queries: function (db, on_success_fn)
    {
      tb.data.Select_Objs(db, '/query', Select_Objs_OK);
      function Select_Objs_OK(queries)
      {
        var todo = queries.length;

        for (c = 0; c < queries.length; c++)
        {
          tb.trend.Insert_From_Query(db, queries[c], Insert_From_Query_OK);
          function Insert_From_Query_OK()
          {
            todo--;
            if (todo == 0 && on_success_fn != null)
              on_success_fn();
          }
        }
      }
    },

    Update: function (db, obj, on_success_fn)
    {

    },

    Delete: function (db, id, on_success_fn)
    {
      db.conn.ref("/" + this.table_name + "/" + id).remove(on_success_fn);
    },
  };
</script>