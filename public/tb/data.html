<script type="text/javascript">
  tb.data =
  {
    Db: function ()
    {
      var config;

      config =
      {
        apiKey: "AIzaSyAITTb3Fxh1HiyFxdObmgZ2LqJZm38EQ5k",
        authDomain: "trend-buddy.firebaseapp.com",
        databaseURL: "https://trend-buddy.firebaseio.com",
        storageBucket: "trend-buddy.appspot.com",
        messagingSenderId: "603649293586"
      };
      firebase.initializeApp(config);
      this.conn = firebase.database();

      this.cache = [];

      this.Exists_In_Cache = function (key)
      {
        var res = false;

        if (this.cache[key] != null)
          res = true;

        return res;
      };

      this.Get_From_Cache = function (key)
      {
        return this.cache[key];
      };

      this.Insert_In_Cache = function (key, val)
      {
        this.cache[key] = val;
      };

      this.If_Not_In_Cache = function (key, get_val_fn, on_success_fn)
      {
        var val = null;

        if (this.Exists_In_Cache(key))
        {
          val = this.Get_From_Cache(key);
          on_success_fn(val);
        }
        else
        {
          get_val_fn();
        }
      };

      this.Exists_In_Cache2 = function (key, on_success_fn)
      {
        if (this.cache[key] != null && on_success_fn)
        {
          on_success_fn(true);
        }
        else
        {
          this.conn.ref("/cache/" + key).once('value').then(Cache_Read_OK);
          function Cache_Read_OK(query_res)
          {
            var val = query_res.val();
            if (val)
              on_success_fn(true);
            else
              on_success_fn(false);
          }
        }
      };

      this.Get_From_Cache2 = function (key, parse_fn, on_success_fn)
      {
        var cache, val;

        cache = this.cache;
        val = this.cache[key];
        if (val == null)
        {
          db.conn.ref("/cache/" + key).once('value').then(Then_OK);
          function Then_OK(query_res)
          {
            val = query_res.val();
            val = JSON.parse(val);
            if (parse_fn)
              val = parse_fn(val);
            cache[key] = val;
            on_success_fn(val);
          }
        }
        else
          on_success_fn(val);
      };

      this.Insert_In_Cache2 = function (key, val, on_success_fn)
      {
        this.cache[key] = val;
        db.conn.ref("/cache/" + key).set(JSON.stringify(val), Insert_OK);
        function Insert_OK()
        {
          on_success_fn(val);
        }
      };

      this.If_Not_In_Cache2 = function (key, get_val_fn, parse_fn, on_success_fn)
      {
        var val = null, db = this;

        db.Exists_In_Cache2(key, Exists_OK);
        function Exists_OK(exists)
        {
          if (exists)
          {
            val = db.Get_From_Cache2(key, parse_fn, on_success_fn);
          }
          else
          {
            get_val_fn();
          }
        }
      };
    },

    Select_Obj: function (db, path, on_success_fn)
    {
      db.conn.ref(path).once('value').then(Then_OK);
      function Then_OK(query_res)
      {
        if (on_success_fn != null)
          on_success_fn(tb.data.To_Obj(query_res));
      }
    },

    Select_Objs: function (db, path, on_success_fn)
    {
      db.conn.ref(path).once('value').then(Then_OK);
      function Then_OK(query_res)
      {
        tb.data.To_Array(query_res, on_success_fn);
      }
    },

    To_Obj: function (query_res)
    {
      return query_res.val();
    },

    To_Array: function (query_res, success_fn)
    {
      var val, vals = null, keys, c;

      val = query_res.val();
      if (val != null)
      {
        if (val.constructor === Array)
          vals = val;
        else
        {
          vals = new Array();
          keys = Object.keys(val);
          for (c = 0; c < keys.length; c++)
          {
            vals.push(val[keys[c]]);
          }
        }
      }

      if (success_fn != null)
        success_fn(vals);
      else
        return vals;
    },

    Get_Table: function (obj)
    {
      return obj.constructor.name.toLowerCase();
    },
  };
</script>