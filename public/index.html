<html>

<head>
  <title>Trend Buddy</title>

  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-database.js"></script>

  <script src="/webcomponentsjs/webcomponents-loader.js"></script>
  <script type="module">
    import '/polymer/iron-icons/iron-icons.js';
    import '/polymer/iron-collapse/iron-collapse.js';
    import '/polymer/paper-icon-button/paper-icon-button.js';
    import '/polymer/paper-toast/paper-toast.js';
    import '/polymer/paper-spinner/paper-spinner.js';
    import '/polymer/paper-checkbox/paper-checkbox.js';
    import '/polymer/paper-toggle-button/paper-toggle-button.js';
    import '/polymer/app-layout/app-drawer-layout/app-drawer-layout.js';
    import '/polymer/app-layout/app-drawer/app-drawer.js';
    import '/polymer/app-layout/app-header-layout/app-header-layout.js';
    import '/polymer/app-layout/app-header/app-header.js';
    import '/polymer/app-layout/app-toolbar/app-toolbar.js';
    import '/tb-elements/query-editor.js';
    import '/tb-elements/query-menu-item.js';
    import '/tb-elements/query-stats.js';
    import '/tb-elements/query-rankings.js';
    import '/tb-elements/query-weights.js';
  </script>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script type="text/javascript" src="/tb/init.js"></script>
  <script type="text/javascript" src="/tb/data.js"></script>
  <script type="text/javascript" src="/tb/query.js"></script>
  <script type="text/javascript" src="/tb/trend.js"></script>

  <style>
    @font-face
    {
      font-family: roboto;
      src: url(fonts/Roboto-Regular.ttf);
    }

    @font-face
    {
      font-family: roboto-light;
      src: url(fonts/Roboto-Light.ttf);
    }

    @font-face
    {
      font-family: roboto-thin;
      src: url(fonts/Roboto-Thin.ttf);
    }

    #blogger
    {
      margin: -2px;
    }

    #signature
    {
      font-size: 14px;
      color: #00ff00;
      text-align: right;
    }

    #signature a
    {
      color: #00ff00;
      text-decoration: none;
    }

    #signature a:visited
    {
      color: #00ff00;
      text-decoration: none;
    }

    app-drawer-layout:not([narrow]) [drawer-toggle]
    {
      display: none;
    }

    body
    {
      font-family: roboto-light;
      color: #00ff00;
      background-color: black;
      text-shadow: #00ff00 0px 0px 10px, #00ff00 0px 0px 10px;
    }

    #title
    {
      font-size: 30px;
    }

    #query_items
    {
      height: 100%;
      overflow: auto;
      background-color: black;
    }

    #query_items::-webkit-scrollbar
    {
      width: 1em;
    }

    #query_items::-webkit-scrollbar-track
    {
      background-color: #002200;
    }

    #query_items::-webkit-scrollbar-thumb
    {
      background-color: #00aa00;
    }

    #curve_chart
    {
      height: 90%;
    }

    #curve_chart p
    {
      margin: 0px 50px 25px 50px;
    }

    #man_items
    {
      margin: 0px 50px 25px 50px;
    }

    #man_items li
    {
      margin: 0px 0px 10px 0px;
    }

    .overlay
    {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background: radial-gradient(circle, rgba(0,0,0,1) 2%, rgba(0,0,0,0.4) 60%);
      align-items: center;
      justify-content: center;
      display: none;
    }

    paper-toggle-button
    {
      --paper-toggle-button-checked-bar-color: #00ff00;
      --paper-toggle-button-checked-button-color: #00ff00;
      --paper-toggle-button-checked-ink-color: #00ff00;
      --paper-toggle-button-unchecked-bar-color: #ff0000;
      --paper-toggle-button-unchecked-button-color: #ff0000;
      --paper-toggle-button-unchecked-ink-color: #ff0000;
      --paper-toggle-button-label-color: #00ff00;
    }

    div.google-visualization-tooltip
    {
      background-color: #000000;
      border: 1px solid #00ff00;
      box-shadow: none;
    }
    
    #menu_items::-webkit-scrollbar
    {
      width: 1em;
    }

    #menu_items::-webkit-scrollbar-track
    {
      background-color: #002200;
    }

    #menu_items::-webkit-scrollbar-thumb
    {
      background-color: #00aa00;
    }

    #menu_items
    {
      overflow: auto;
      height: 100%;
    }

    #stats_elem
    {
      display: none;
      margin-left: 20px;
    }
  </style>

  <script>
    var db, chart_data;

    // Events =====================================================================================

    window.onload = Main;
    function Main()
    {
      var toggle_elem, menu_elem;

      db = new Db();

      menu_elem = document.createElement("query-menu-item");
      menu_elem.id = "query_menu";
      menu_elem.db = db;
      menu_elem.On_Show_Chart = On_Show_Chart;
      menu_elem.On_Choose_Chart = On_Choose_Chart;
      menu_elem.On_Choose_Trend = On_Choose_Trend;
      menu_items.append(menu_elem);

      Init_Chart();

      toggle_elem = document.getElementById("rel_button");
      toggle_elem.onclick = On_Relative_Click;
    }

    function On_Choose_Trend(event)
    {
      event.stopPropagation();
      Util.Clr(stats_elem);

      // add rankings
      const rank_elem = document.createElement("query-rankings");
      rank_elem.db = db;
      rank_elem.query = this.query;
      rank_elem.child_queries = this.child_queries;
      stats_elem.append(rank_elem);

      // add pie chart
      const weight_elem = document.createElement("query-weights");
      weight_elem.db = db;
      weight_elem.query = this.query;
      weight_elem.child_queries = this.child_queries;
      stats_elem.append(weight_elem);

      stats_elem.append(document.createElement("br"));

      // add movement panels for each tech
      for (c=0; c<this.child_queries.length; c++)
      {
        const stat_elem = document.createElement("query-stats");
        stat_elem.db = db;
        stat_elem.query = this.child_queries[c];

        stats_elem.append(stat_elem);
      }

      Util.Hide(curve_chart);
      Util.Show(stats_elem);
    }

    function On_Choose_Chart(event)
    {
      event.stopPropagation();
      if (this.checked)
      {
        Draw_Chart_By_Query_Id(db, this.query.id, false, Is_Relative_Chart());
      }
      else if (Charts_Displayed(chart_data) > 1)
      {
        if (Charts_Displayed(chart_data) == 2)
        {
          Set_Absolute_Chart();
        }
        Hide_Chart(this.query, Is_Relative_Chart());
      }
      else
      {
        this.checked = true;
      }

      Util.Hide(stats_elem);
      Util.Show(curve_chart);
    }

    function On_Show_Chart(event)
    {
      Set_Absolute_Chart();
      query_menu.Uncheck();
      this.querySelector("#checkbox").checked = true;
      Draw_Chart_By_Query_Id(db, this.query.id, true, false);

      Util.Hide(stats_elem);
      Util.Show(curve_chart);
    }

    async function On_Relative_Click()
    {
      if (Charts_Displayed(chart_data) < 2 && Is_Relative_Chart())
      {
        Set_Absolute_Chart();
      }

      Draw_Chart(chart_data, Is_Relative_Chart());
    }

    // UI =========================================================================================

    function Init_Chart()
    {
      var chart_elem;

      chart_elem = document.getElementById('curve_chart');

      google.charts.load('current', { 'packages': ['corechart'] });
      google.charts.setOnLoadCallback(Load_OK);
      function Load_OK()
      {
        var chart;

        chart = new google.visualization.LineChart(chart_elem);
        chart_elem.chart = chart;
      }
    }

    function Draw_Chart_By_Query_Id(db, id, single_query, is_relative)
    {
      document.getElementById("wait_dlg").style.display = "flex";
      Query.Select_Obj(db, id, Select_Obj_OK);
      function Select_Obj_OK(query)
      {
        Trend.Select_Chart_Vals_By_Query(db, query, Have_Trend_Objs);
        function Have_Trend_Objs(data_vals)
        {
          if (Util.Empty(data_vals))
            document.getElementById("no_data").show();
          else
          {
            if (chart_data == null || single_query)
              chart_data = Copy_Data(data_vals);
            else
              Merge_Data(chart_data, data_vals);

            Draw_Chart(chart_data, is_relative);
          }

          document.getElementById("wait_dlg").style.display = "none";
        }
      }
    }

    function Hide_Chart(query, is_relative)
    {
      var i, col_idx, new_data;

      for (i = 0; i < chart_data[0].length; i++)
        if (chart_data[0][i] == query.title)
          col_idx = i;

      new_data = [];
      for (i = 0; i < chart_data.length; i++)
      {
        chart_data[i].splice(col_idx, 1);
        if (Row_Has_Data(chart_data[i]))
          new_data.push(chart_data[i]);
      }
      chart_data = new_data;

      Draw_Chart(chart_data, is_relative);
    }

    function Draw_Chart(chart_data, is_relative)
    {
      var data_table, options, draw_data;

      if (is_relative)
        draw_data = To_Relative_Data(chart_data);
      else
        draw_data = chart_data;

      data_table = google.visualization.arrayToDataTable(draw_data);
      options = {
        curveType: 'line',
        chartArea: { width: "90%", height: "80%" },
        legend:
        {
          position: "top",
          textStyle: { fontName: "roboto", fontSize: 14, color: "#00ff00" }
        },
        animation: { startup: false, duration: 0, easing: 'linear', },
        interpolateNulls: true,
        fontName: "roboto",
        fontSize: 9,
        backgroundColor: "#000000",
        vAxis:
        {
          baselineColor: "#002200",
          gridlines: { color: "#002200" },
          minorGridlines: { color: "#002200" },
          textStyle: { color: "#00ff00" }
        },
        hAxis:
        {
          baselineColor: "#002200",
          gridlines: { color: "#002200" },
          minorGridlines: { color: "#002200" },
          textStyle: { color: "#00ff00" }
        },
        tooltip:
        {
          textStyle: { color: "#00ff00" },
          isHtml: true
        }
      };
      document.getElementById("curve_chart").chart.draw(data_table, options);
    }

    function Is_Relative_Chart()
    {
      return document.getElementById("rel_button").checked;
    }

    function Set_Absolute_Chart()
    {
      document.getElementById("rel_button").checked = false;
    }

    // Data Manipulation ==========================================================================

    function Charts_Displayed(chart_data)
    {
      var res = 0;

      if (chart_data && chart_data.length > 0 && chart_data[0].length > 1)
        res = chart_data[0].length - 1;

      return res;
    }

    function To_Relative_Data(chart_data)
    {
      var row, col, rel_data = [], row_data, row_tot;

      rel_data.push(chart_data[0]);
      for (row = 1; row < chart_data.length; row++)
      {
        row_data = New_Filled_Row(chart_data, row);
        row_tot = Calc_Row_Total(row_data);
        for (col = 1; col < row_data.length; col++)
        {
          if (row_data[col] != null)
          {
            row_data[col] = row_data[col] / row_tot * 100;
            if (row_data[col] == 100)
              row_data[col] = null;
          }
        }
        rel_data.push(row_data);
      }

      return rel_data;
    }

    function New_Filled_Row(chart_data, row_index)
    {
      var col, new_row, curr_row;

      curr_row = chart_data[row_index];

      new_row = [];
      new_row.push(curr_row[0]);

      for (col = 1; col < curr_row.length; col++)
      {
        if (curr_row[col] == null)
          new_row.push(Find_Prev_Val(chart_data, row_index-1, col));
        else
          new_row.push(curr_row[col]);
      }

      return new_row;
    }

    function Find_Prev_Val(chart_data, row_index, col_index)
    {
      var row, val = null;

      for (row = row_index; row > 0; row--)
      {
        if (chart_data[row][col_index] != null)
        {
          val = chart_data[row][col_index];
          break;
        }
      }

      return val;
    }

    function Calc_Row_Total(row_data)
    {
      var col, tot=0;

      for (col = 1; col < row_data.length; col++)
      {
        tot += row_data[col];
      }

      return tot;
    }

    function Row_Has_Data(row)
    {
      var i, has_data = false;

      for (i = 1; i < row.length && !has_data; i++)
        if (row[i])
          has_data = true;

      return has_data;
    }

    function Copy_Data(data)
    {
      var res = null, i;

      if (data)
      {
        res = [];
        for (i = 0; i < data.length; i++)
          res.push(data[i].slice());
      }
      return res;
    }

    function Merge_Data(dest, src)
    {
      var i, row;

      if (dest && src)
      {
        Add_Column(dest, src[0][1]);
        for (i = 1; i < src.length; i++)
        {
          row = Find_Row(dest, src[i][0]);
          if (row)
          {
            if (row.action == "add")
            {
              Add_Row(dest, src[i]);
            }
            else if (row.action == "insert")
            {
              Insert_Row(dest, row.index, src[i]);
            }
            else if (row.action == "set")
            {
              Set_Row(dest, row.index, src[i]);
            }
          }
        }
      }
    }

    function Add_Column(dst, name)
    {
      var i, title_row;

      for (i = 0; i < dst.length; i++)
        dst[i].push(null);
      title_row = dst[0];
      title_row[title_row.length - 1] = name;
    }

    function Find_Row(data, val)
    {
      var i, res = null;

      if (data && val)
      {
        for (i = 1; i < data.length && res == null; i++)
        {
          if (data[i][0] == val)
            res = { index: i, action: "set" };
          else if (data[i][0] > val)
            res = { index: i, action: "insert" };
        }
        if (res == null)
          res = { index: null, action: "add" };
      }

      return res;
    }

    function Add_Row(dst, row)
    {
      var new_row = New_Row(row, dst[0].length);
      dst.push(new_row);
    }

    function Insert_Row(dst, row_index, row)
    {
      var new_row = New_Row(row, dst[0].length);
      dst.splice(row_index, 0, new_row);
    }

    function Set_Row(dst, row_index, row)
    {
      var dst_row = dst[row_index];
      dst_row[dst_row.length - 1] = row[1];
    }

    function New_Row(row, required_length)
    {
      var new_row, i;

      new_row = [];
      for (i = 0; i < required_length; i++)
        new_row.push(null);
      new_row[0] = row[0]; // insert date
      new_row[required_length - 1] = row[1]; // insert job count

      return new_row;
    }
  </script>
</head>

<body>

  <app-drawer-layout>

    <app-drawer id="menu_drawer" slot="drawer">
      <div id="menu_items"></div>
    </app-drawer>

    <app-header-layout>
      <app-header id="header" slot="header">
        <app-toolbar>
          <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
          <div id="title" main-title>Trend Buddy</div>
          <paper-toggle-button id="rel_button">Relative</paper-toggle-button>
        </app-toolbar>
      </app-header>

      <div id="curve_chart">
        <p>Every day, Trend Buddy takes note of the number of jobs posted demanding experience with various technologies.
        This, in turn, is used to generate comparative charts. 
        If, like me, you're an IT professional you might find this information helpful when determining which skills are worth pursuing. 
        Each chart, individually, is not overly useful but when combined with others can give us some insight into which technologies are in demand and which are on the way out.</p>
        
        <ul id="man_items">
          <li>To view job requests for a single tech just click on the appropriate tech title.</li>
          <li>To compare several tech charts use the checkboxes.</li>
          <li>To compare several techs in a relative way so that each tech point no longer represents the
            exact number of jobs found but rather, the percentage of jobs out of the total for all the included
            techs, use the "Relative" switch on the top-right of the page.</li>
          </ul>

        <p>Also, Trend Buddy has only been tested on Chrome.</p>

        <p>Tech used to build this site includes VS Code, Eclipse, Javascript, Polymer, Firebase, Google App Engine, Node, and Java.</p>

        <p id="signature">- <a href="https://www.linkedin.com/in/esteban-ramirez-91a66b14/">Esteban (Steven) Ramirez</a>
        <a href="https://www.linkedin.com/in/esteban-ramirez-91a66b14" target="_blank"><img src="/images/In-2C-14px.png" /></a>
        <a href="http://ramirezsystems.blogspot.com" target="_blank"><img id="blogger" src="/images/icons8-blogger-18.png" /></a></p>
      </div>

      <div id="stats_elem">
      </div>

    </app-header-layout>
  </app-drawer-layout>

  <div id="wait_dlg" class="overlay">
    <paper-spinner active></paper-spinner>
  </div>

  <paper-toast id="no_data" text="No data is available yet."></paper-toast>

</body>

</html>