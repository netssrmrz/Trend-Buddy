<html>

<head>
  <title>Trend Buddy</title>

  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-database.js"></script>

  <script src="/webcomponentsjs/webcomponents-loader.js"></script>
  <script type="module">
    import '/polymer/paper-icon-button/paper-icon-button.js';
    import '/polymer/iron-icons/iron-icons.js';
    import '/polymer/paper-toast/paper-toast.js';
    import '/polymer/paper-spinner/paper-spinner.js';
    import '/polymer/paper-checkbox/paper-checkbox.js';
    import '/polymer/app-layout/app-drawer-layout/app-drawer-layout.js';
    import '/polymer/app-layout/app-drawer/app-drawer.js';
    import '/polymer/app-layout/app-header-layout/app-header-layout.js';
    import '/polymer/app-layout/app-header/app-header.js';
    import '/polymer/app-layout/app-toolbar/app-toolbar.js';
    import '/tb-elements/query-editor.js';
  </script>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script type="text/javascript" src="/tb/init.js"></script>
  <script type="text/javascript" src="/tb/data.js"></script>
  <script type="text/javascript" src="/tb/query.js"></script>
  <script type="text/javascript" src="/tb/trend.js"></script>

  <style>
    @font-face
    {
      font-family: roboto;
      src: url(fonts/Roboto-Regular.ttf);
    }

    #blogger
    {
      margin: -2px;
    }

    #signature
    {
      font-size: 14px;
      color: gray;
      text-align: right;
    }

    #signature a
    {
      color: gray;
      text-decoration: none;
    }

    #signature a:visited
    {
      color: gray;
      text-decoration: none;
    }

    app-drawer-layout:not([narrow]) [drawer-toggle]
    {
      display: none;
    }

    body
    {
      font-family: roboto;
    }

    #title
    {
      font-size: 30px;
    }

    #header
    {
      color: black;
      background-color: white;
    }

    #query_items
    {
      height: 100%;
      overflow: auto;
      background-color: lightgreen;
    }

    .menu_items
    {
    }

    .menu_items iron-icon
    {
      color: #616161;
      margin-right: 20px;
      vertical-align: text-bottom;
    }

    .menu_items paper-checkbox
    {
      float: right;
    }

    .menu_items a:hover iron-icon
    {
      color: #00cc00;
    }

    .menu_items a
    {
      font-weight: 500;
      font-size: 14px;
      display: block;
      padding: 10px 20px 10px 20px;
    }

    .menu_items a:hover
    {
      background-color: #f5f5f5;
      color: #00cc00;
      cursor: pointer;
    }

    #curve_chart
    {
      height: 90%;
    }

    #curve_chart p
    {
      margin: 0px 50px 25px 50px;
    }

    .overlay
    {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background: radial-gradient(circle, rgba(220,220,220,0.9) 2%, rgba(0,0,0,0.2) 20%);
      align-items: center;
      justify-content: center;
      display: none;
    }
  </style>

  <script>
    var db, chart_data;

    window.onload = Main;
    function Main()
    {
      db = new Db();

      List_Query_Items();
      Init_Chart();
    }

    function Init_Chart()
    {
      var chart_elem;

      chart_elem = document.getElementById('curve_chart');

      google.charts.load('current', { 'packages': ['corechart'] });
      google.charts.setOnLoadCallback(Load_OK);
      function Load_OK()
      {
        var chart;

        chart = new google.visualization.LineChart(chart_elem);
        chart_elem.chart = chart;
      }
    }

    function List_Query_Items()
    {
      Query.Select_Objs(db, Select_OK);
      function Select_OK(queries)
      {
        var c, list_elem;

        list_elem = document.getElementById("query_items");

        for (c = 0; c < queries.length; c++)
        {
          var item_elem, query, chk_elem;

          query = queries[c];
          item_elem = document.createElement("a");
          item_elem.text = query.title;
          item_elem.query = query;
          item_elem.onclick = On_Show_Chart;

          chk_elem = document.createElement("paper-checkbox");
          chk_elem.id = "query_chk_" + query.id;
          chk_elem.query = query;
          chk_elem.onclick = On_Choose_Chart;
          item_elem.appendChild(chk_elem);

          list_elem.appendChild(item_elem);
        }
      }
    }

    function On_Choose_Chart(event)
    {
      event.stopPropagation();
      if (this.checked)
        Draw_Chart_By_Query_Id(db, this.query.id, false);
      else
        Hide_Chart(this.query);
    }

    function On_Show_Chart()
    {
      Uncheck_All_Queries();
      document.getElementById("query_chk_" + this.query.id).checked = true;
      Draw_Chart_By_Query_Id(db, this.query.id, true);
    }

    function Uncheck_All_Queries()
    {
      var chk_elems, i;

      chk_elems = document.querySelectorAll("#query_items paper-checkbox");
      for (i = 0; i < chk_elems.length; i++)
        chk_elems[i].checked = false;
    }

    function Draw_Chart_By_Query_Id(db, id, single_query)
    {
      document.getElementById("wait_dlg").style.display = "flex";
      Query.Select_Obj(db, id, Select_Obj_OK);
      function Select_Obj_OK(query)
      {
        Trend.Select_Chart_Vals_By_Query(db, query, Select_OK);
        function Select_OK(data_vals)
        {
          if (Util.Empty(data_vals))
            document.getElementById("no_data").show();
          else
          {
            if (chart_data == null || single_query)
              chart_data = Copy_Data(data_vals);
            else
              Merge_Data(chart_data, data_vals);

            Draw_Chart();
          }

          document.getElementById("wait_dlg").style.display = "none";
        }
      }
    }

    function Hide_Chart(query)
    {
      var i, col_idx, new_data;

      for (i = 0; i < chart_data[0].length; i++)
        if (chart_data[0][i] == query.title)
          col_idx = i;

      new_data = [];
      for (i = 0; i < chart_data.length; i++)
      {
        chart_data[i].splice(col_idx, 1);
        if (Row_Has_Data(chart_data[i]))
          new_data.push(chart_data[i]);
      }
      chart_data = new_data;

      Draw_Chart();
    }

    function Draw_Chart()
    {
      var data_table, options;

      data_table = google.visualization.arrayToDataTable(chart_data);
      options = {
        curveType: 'line',
        chartArea: { width: "90%", height: "80%" },
        legend:
        {
          position: "top",
          textStyle: { fontName: "roboto", fontSize: 14 }
        },
        animation: { startup: false, duration: 0, easing: 'linear', },
        interpolateNulls: true,
        fontName: "roboto",
        fontSize: 9
      };
      document.getElementById("curve_chart").chart.draw(data_table, options);
    }

    function Row_Has_Data(row)
    {
      var i, has_data = false;

      for (i = 1; i < row.length && !has_data; i++)
        if (row[i])
          has_data = true;

      return has_data;
    }

    function Copy_Data(data)
    {
      var res = null, i;

      if (data)
      {
        res = [];
        for (i = 0; i < data.length; i++)
          res.push(data[i].slice());
      }
      return res;
    }

    function Merge_Data(dest, src)
    {
      var i, row;

      if (dest && src)
      {
        Add_Column(dest, src[0][1]);
        for (i = 1; i < src.length; i++)
        {
          row = Find_Row(dest, src[i][0]);
          if (row)
          {
            if (row.action == "add")
            {
              Add_Row(dest, src[i]);
            }
            else if (row.action == "insert")
            {
              Insert_Row(dest, row.index, src[i]);
            }
            else if (row.action == "set")
            {
              Set_Row(dest, row.index, src[i]);
            }
          }
        }
      }
    }

    function Add_Column(dst, name)
    {
      var i, title_row;

      for (i = 0; i < dst.length; i++)
        dst[i].push(null);
      title_row = dst[0];
      title_row[title_row.length - 1] = name;
    }

    function Find_Row(data, val)
    {
      var i, res = null;

      if (data && val)
      {
        for (i = 1; i < data.length && res == null; i++)
        {
          if (data[i][0] == val)
            res = { index: i, action: "set" };
          else if (data[i][0] > val)
            res = { index: i, action: "insert" };
        }
        if (res == null)
          res = { index: null, action: "add" };
      }

      return res;
    }

    function Add_Row(dst, row)
    {
      var new_row = New_Row(row, dst[0].length);
      dst.push(new_row);
    }

    function Insert_Row(dst, row_index, row)
    {
      var new_row = New_Row(row, dst[0].length);
      dst.splice(row_index, 0, new_row);
    }

    function Set_Row(dst, row_index, row)
    {
      var dst_row = dst[row_index];
      dst_row[dst_row.length - 1] = row[1];
    }

    function New_Row(row, required_length)
    {
      var new_row, i;

      new_row = [];
      for (i = 0; i < required_length; i++)
        new_row.push(null);
      new_row[0] = row[0]; // insert date
      new_row[required_length - 1] = row[1]; // insert job count

      return new_row;
    }
  </script>
</head>

<body>

  <app-drawer-layout>

    <app-drawer slot="drawer">
      <div id="query_items" class="menu_items"></div>
    </app-drawer>

    <app-header-layout>
      <app-header id="header" slot="header">
        <app-toolbar>
          <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
          <div id="title" main-title>Trend Buddy</div>
        </app-toolbar>
      </app-header>

      <div id="curve_chart">
        <p>Everybody needs buddies. This one is no exception.</p>
        <p>Every day, Trend Buddy takes note of the number of jobs posted for each of the "tech" areas listed on the left.
        Armed with this information, Trend Buddy can chart the demand for work across these areas. 
        If, like me, you're an IT professional you might find this information helpful when determining which skills are worth pursuing. 
        Each chart, individually, is not overly useful but when combined with others can give us some insight into which technologies are in demand and which are on the way out.</p>
        <p>Use the green tech list, on the left, to view job charts. 
        To view a chart relating to a single tech just click on the appropriate tech title. 
        To view a chart combining several tech charts use the checkboxes.</p>
        <p id="signature">- <a href="https://www.linkedin.com/in/esteban-ramirez-91a66b14/">Esteban (Steven) Ramirez</a>
        <a href="https://www.linkedin.com/in/esteban-ramirez-91a66b14" target="_blank"><img src="/images/In-2C-14px.png" /></a>
        <a href="http://ramirezsystems.blogspot.com" target="_blank"><img id="blogger" src="/images/icons8-blogger-18.png" /></a></p>
      </div>

    </app-header-layout>
  </app-drawer-layout>

  <div id="wait_dlg" class="overlay">
    <paper-spinner active></paper-spinner>
  </div>

  <paper-toast id="no_data" text="No data is available yet."></paper-toast>

</body>

</html>