<html>

<head>
  <title>Trend Buddy</title>

  <script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-database.js"></script>

  <script src="/pl-elements/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import" href="/pl-elements/polymer/polymer.html">
  <link rel="import" href="/pl-elements/paper-drawer-panel/paper-drawer-panel.html">
  <link rel="import" href="/pl-elements/paper-header-panel/paper-header-panel.html">
  <link rel="import" href="/pl-elements/paper-toolbar/paper-toolbar.html">
  <link rel="import" href="/pl-elements/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="/pl-elements/iron-icons/iron-icons.html">
  <link rel="import" href="/pl-elements/paper-toast/paper-toast.html">
  <link rel="import" href="/pl-elements/paper-spinner/paper-spinner.html">

  <link rel="import" href="/tb/init.html">
  <link rel="import" href="/tb/data.html">
  <link rel="import" href="/tb/trend.html">
  <link rel="import" href="/tb/query.html">
  <link rel="import" href="/tb/indeed.html">

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    @font-face {
      font-family: roboto;
      src: url(fonts/Roboto-Regular.ttf);
    }

    body {
      font-family: roboto;
    }

    .menu_items {
      margin: 20px 0px 20px 0px;
    }

    .menu_items iron-icon {
      color: #616161;
      margin-right: 20px;
      vertical-align: text-bottom;
    }

    .menu_items a:hover iron-icon {
      color: #00cc00;
    }

    .menu_items a {
      font-weight: 500;
      font-size: 14px;
      display: block;
      padding: 10px 20px 10px 20px;
    }

    .menu_items a:hover {
      background-color: #f5f5f5;
      color: #00cc00;
      cursor: pointer;
    }

    #curve_chart {
      height: 90%;
    }

    .overlay
    {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background: radial-gradient(circle, rgba(220,220,220,0.9) 2%, rgba(0,0,0,0.2) 20%);
      align-items: center;
      justify-content: center;
      display: none;
    }
  </style>

  <script type="text/javascript">
    var db;

    function Main()
    {
      db = new tb.data.Db();

      List_Query_Items();
      Init_Chart();
    }

    function Init_Chart() 
    {
      var chart_elem;

      chart_elem = document.getElementById('curve_chart');

      google.charts.load('current', { 'packages': ['corechart'] });
      google.charts.setOnLoadCallback(Load_OK);
      function Load_OK()
      {
        var chart;

        chart = new google.visualization.LineChart(chart_elem);
        chart_elem.chart = chart;
      }
    }

    function List_Query_Items()
    {
      tb.query.Select(db, Select_OK);
      function Select_OK(queries)
      {
        var c, list_elem;

        list_elem = document.getElementById("query_items");

        for (c = 0; c < queries.length; c++)
        {
          var item_elem, query;

          query = queries[c];
          item_elem = document.createElement("a");
          item_elem.text = query.title;
          item_elem.query = query;
          item_elem.onclick = On_Show_Chart;

          list_elem.appendChild(item_elem);
        }
      }
    }

    function Draw_Chart_By_Query_Id(db, id)
    {
      tb.query.Select_Obj(db, id, Select_Obj_OK);
      function Select_Obj_OK(query)
      {
        tb.trend.Select_Chart_Vals_By_Query_Id(db, id, Select_OK);
        function Select_OK(data_vals)
        {
          var data_table, options;

          if (tb.Empty(data_vals))
            alert("No Data");
          else
          {
            data_table = google.visualization.arrayToDataTable(data_vals);
            options = {
              title: query.title,
              curveType: 'line',
              chartArea: { width: "80%", height: "80%" },
              legend: { position: "none" },
              animation: { duration: 1000, easing: 'linear', },
            };
            document.getElementById("wait_dlg").style.display = "none";
            document.getElementById("curve_chart").chart.draw(data_table, options);
          }
        }
      }
    }

    function Draw_Chart_By_Query_Id2(db, id)
    {
      tb.query.Select_Obj(db, id, Select_Obj_OK);
      function Select_Obj_OK(query)
      {
        var data_table, options;

        data_table = new google.visualization.DataTable();
        data_table.addColumn("datetime", "Date");
        data_table.addColumn("number", "Jobs");

        options = {
          title: query.title,
          curveType: 'line',
          chartArea: { width: "80%", height: "80%" },
          legend: { position: "none" },
          animation: { duration: 0, easing: 'linear', },
        };

        document.getElementById("curve_chart").chart.draw(data_table, options);
        Draw_Segment(db, query.id, null, data_table, options);
      }
    }

    function Draw_Segment(db, query_id, start_key, data_table, options)
    {
      var seg_size = 100;

      if (start_key!=null)
        db.conn.ref("/query-trend/" + query_id).orderByKey().startAt(start_key).limitToFirst(seg_size).once("value", OK_Fn);
      else
        db.conn.ref("/query-trend/" + query_id).orderByKey().limitToFirst(seg_size).once("value", OK_Fn);
      function OK_Fn(snapshot)
      {
        var keys, todo, c;

        keys = Object.keys(snapshot.val());
        todo = keys.length - 1;
        for (c = 0; c < keys.length-1; c++)
        {
          tb.trend.Select_Obj(db, keys[c], Select_OK);
          function Select_OK(trend)
          {
            data_table.addRow([new Date(trend.datetime), trend.count]);
            todo--;

            if (todo == 0)
            {
              document.getElementById("curve_chart").chart.draw(data_table, options);
              setTimeout(Draw_Next_Segment);
              function Draw_Next_Segment()
              {
                Draw_Segment(db, query_id, keys[keys.length - 1], data_table, options);
              }
            }
          }
        }
      }
    }

    function On_Show_Chart()
    {
      document.getElementById("wait_dlg").style.display = "flex";
      Draw_Chart_By_Query_Id(db, this.query.id);
    }

  </script>
</head>

<body>
  <paper-drawer-panel>
    <paper-header-panel drawer>

      <paper-toolbar>
        <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
        <div>Trend Buddy</div>
      </paper-toolbar>

      <div id="query_items" class="menu_items">
      </div>

    </paper-header-panel>

    <paper-header-panel main>

      <paper-toolbar>
        <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
      </paper-toolbar>

      <div id="curve_chart"></div>

    </paper-header-panel>
  </paper-drawer-panel>

  <div id="wait_dlg" class="overlay">
    <paper-spinner active></paper-spinner>
  </div>

</body>

</html>