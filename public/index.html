<html>

<head>
  <title>Trend Buddy</title>

  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-database.js"></script>

  <script type="module">
    import '/polymer/paper-icon-button/paper-icon-button.js';
    import '/polymer/iron-icons/iron-icons.js';
    import '/polymer/paper-toast/paper-toast.js';
    import '/polymer/paper-spinner/paper-spinner.js';
    import '/polymer/paper-checkbox/paper-checkbox.js';
    import '/polymer/app-layout/app-drawer-layout/app-drawer-layout.js';
    import '/polymer/app-layout/app-drawer/app-drawer.js';
    import '/polymer/app-layout/app-header-layout/app-header-layout.js';
    import '/polymer/app-layout/app-header/app-header.js';
    import '/polymer/app-layout/app-toolbar/app-toolbar.js';
    import '/tb-elements/query-editor.js';
  </script>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script type="text/javascript" src="/tb/init.js"></script>
  <script type="text/javascript" src="/tb/data.js"></script>
  <script type="text/javascript" src="/tb/query.js"></script>
  <script type="text/javascript" src="/tb/trend.js"></script>

  <style>
    @font-face
    {
      font-family: roboto;
      src: url(fonts/Roboto-Regular.ttf);
    }

    app-drawer-layout:not([narrow]) [drawer-toggle]
    {
      display: none;
    }

    body
    {
      font-family: roboto;
    }

    #header
    {
      color: white;
      background-color: deepskyblue;
    }

    #query_items
    {
      height: 100%;
      overflow: auto;
    }

    .menu_items
    {
    }

    .menu_items iron-icon
    {
      color: #616161;
      margin-right: 20px;
      vertical-align: text-bottom;
    }

    .menu_items paper-checkbox
    {
      float: right;
    }

    .menu_items a:hover iron-icon
    {
      color: #00cc00;
    }

    .menu_items a
    {
      font-weight: 500;
      font-size: 14px;
      display: block;
      padding: 10px 20px 10px 20px;
    }

    .menu_items a:hover
    {
      background-color: #f5f5f5;
      color: #00cc00;
      cursor: pointer;
    }

    #curve_chart
    {
      height: 90%;
    }

    .overlay
    {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background: radial-gradient(circle, rgba(220,220,220,0.9) 2%, rgba(0,0,0,0.2) 20%);
      align-items: center;
      justify-content: center;
      display: none;
    }
  </style>

  <script>
    var db;

    window.onload = Main;
    function Main()
    {
      db = new Db();

      List_Query_Items();
      Init_Chart();
    }

    function Init_Chart()
    {
      var chart_elem;

      chart_elem = document.getElementById('curve_chart');

      google.charts.load('current', { 'packages': ['corechart'] });
      google.charts.setOnLoadCallback(Load_OK);
      function Load_OK()
      {
        var chart;

        chart = new google.visualization.LineChart(chart_elem);
        chart_elem.chart = chart;
      }
    }

    function List_Query_Items()
    {
      Query.Select_Objs(db, Select_OK);
      function Select_OK(queries)
      {
        var c, list_elem;

        list_elem = document.getElementById("query_items");

        for (c = 0; c < queries.length; c++)
        {
          var item_elem, query, chk_elem;

          query = queries[c];
          item_elem = document.createElement("a");
          item_elem.text = query.title;
          item_elem.query = query;
          item_elem.onclick = On_Show_Chart;

          chk_elem = document.createElement("paper-checkbox");
          chk_elem.onclick = On_Choose_Chart;
          item_elem.appendChild(chk_elem);

          list_elem.appendChild(item_elem);
        }
      }
    }

    function On_Choose_Chart(event)
    {
      event.stopPropagation();
    }

    function Draw_Chart_By_Query_Id(db, id)
    {
      Query.Select_Obj(db, id, Select_Obj_OK);
      function Select_Obj_OK(query)
      {
        Trend.Select_Chart_Vals_By_Query_Id(db, id, Select_OK);
        function Select_OK(data_vals)
        {
          var data_table, options;

          if (Util.Empty(data_vals))
            document.getElementById("no_data").show();
          else
          {
            data_table = google.visualization.arrayToDataTable(data_vals);
            options = {
              title: query.title,
              curveType: 'line',
              chartArea: { width: "80%", height: "80%" },
              legend: { position: "none" },
              animation: { duration: 1000, easing: 'linear', },
            };
            document.getElementById("curve_chart").chart.draw(data_table, options);
          }

          document.getElementById("wait_dlg").style.display = "none";
        }
      }
    }

    function On_Show_Chart()
    {
      document.getElementById("wait_dlg").style.display = "flex";
      Draw_Chart_By_Query_Id(db, this.query.id);
    }

  </script>
</head>

<body>

  <app-drawer-layout>

    <app-drawer slot="drawer">
      <div id="query_items" class="menu_items"></div>
    </app-drawer>

    <app-header-layout>
      <app-header id="header" slot="header">
        <app-toolbar>
          <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
          <div main-title>Trend Buddy</div>
        </app-toolbar>
      </app-header>

      <div id="curve_chart"></div>

    </app-header-layout>
  </app-drawer-layout>

  <div id="wait_dlg" class="overlay">
    <paper-spinner active></paper-spinner>
  </div>

  <paper-toast id="no_data" text="No data is available yet."></paper-toast>

</body>

</html>