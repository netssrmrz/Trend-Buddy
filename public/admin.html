<html>

<head>
  <title>Trend Buddy</title>

  <script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-database.js"></script>

  <script src="/pl-elements/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import" href="/pl-elements/polymer/polymer.html">
  <link rel="import" href="/pl-elements/paper-drawer-panel/paper-drawer-panel.html">
  <link rel="import" href="/pl-elements/paper-header-panel/paper-header-panel.html">
  <link rel="import" href="/pl-elements/paper-toolbar/paper-toolbar.html">
  <link rel="import" href="/pl-elements/iron-icons/iron-icons.html">
  <link rel="import" href="/pl-elements/paper-toast/paper-toast.html">
  <link rel="import" href="/tb-elements/query-editor.html">

  <link rel="import" href="/tb/init.html">
  <link rel="import" href="/tb/data.html">
  <link rel="import" href="/tb/trend.html">
  <link rel="import" href="/tb/query.html">
  <link rel="import" href="/tb/indeed.html">

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    @font-face {
      font-family: roboto;
      src: url(fonts/Roboto-Regular.ttf);
    }

    body {
      font-family: roboto;
    }

    #menu_items {
      margin: 0px 20px 0px 20px;
    }

    #menu_items iron-icon {
      color: #616161;
      margin-right: 20px;
      vertical-align: text-bottom;
    }

    #menu_items a:hover iron-icon {
      color: #00cc00;
    }

    #menu_items a {
      font-weight: 500;
      display: block;
      padding: 15px 10px 15px 10px;
    }

    #menu_items a:hover {
      background-color: #f5f5f5;
      color: #00cc00;
      cursor: pointer;
    }

    #query_form{
      padding: 20px;
    }

    #query_items {
      border-top: 2px solid #eee;
      margin: 0px 20px 0px 20px;
    }

    #query_items a {
      font-weight: 500;
      font-size: 14px;
      display: block;
      padding: 10px 10px 10px 10px;
    }

    #query_items a:hover {
      background-color: #f5f5f5;
      color: #00cc00;
      cursor: pointer;
    }
  </style>

  <script type="text/javascript">
    var db;

    function Main()
    {
      db = new tb.data.Db();

      document.getElementById("add_option").onclick = On_Add_Query;
      document.getElementById("upd_option").onclick = On_Update_All;
      document.getElementById("idx_option").onclick = On_Reindex;

      document.getElementById("qry_edt").on_save_fn = On_Save_Query;
      document.getElementById("qry_edt").on_clr_data_fn = On_Clear_Data;
      document.getElementById("qry_edt").on_del_fn = On_Del_Query;

      List_Query_Items();
    }

    function On_Reindex()
    {
      tb.query.Select(db, Select_OK);
      function Select_OK(queries)
      {
        var c, query;

        for (c = 0; c < queries.length; c++)
        {
          query = queries[c];
          Del_OK.query = query;
          db.conn.ref("/query-trend/" + query.id).remove(Del_OK);
          function Del_OK()
          {
            var query = Del_OK.query;

            tb.trend.Select_By_Query_Id(db, query.id, Select_OK);
            function Select_OK(entries)
            {
              var c, entry;

              for (c = 0; c<entries.length; c++)
              {
                entry = entries[c];
                db.conn.ref("/query-trend/" + query.id + "/" + entry.id).set(entry.datetime);
              }
              document.getElementById("msg").text = "Query \"" + query.title + "\" completed.";
              document.getElementById("msg").show();
            }
          }
        }
      }
    }

    function On_Del_Query(query_id)
    {
      tb.query.Delete(db, query_id, Delete_OK);
      function Delete_OK()
      {
        document.getElementById("del_ok").show();
      }
    }

    function On_Clear_Data(query_id)
    {
      tb.query.Delete_Trend_Data(db, query_id, Delete_Trend_Data_OK);
      function Delete_Trend_Data_OK()
      {
        document.getElementById("trend_del_ok").show();
      }
    }

    function List_Query_Items()
    {
      tb.query.Select(db, Select_OK);
      function Select_OK(queries)
      {
        var c, list_elem;

        list_elem = document.getElementById("query_items");

        for (c = 0; c < queries.length; c++)
        {
          var item_elem, query;

          query = queries[c];
          Insert_Query_Item(list_elem, query);
        }
      }
    }

    function On_Add_Query()
    {
      document.getElementById("qry_edt").item_elem = null;
      document.getElementById("qry_edt").Add();
    }

    function On_Edit_Query()
    {
      document.getElementById("qry_edt").item_elem = this;

      tb.query.Select_Obj(db, this.query.id, Select_Obj_OK);
      function Select_Obj_OK(query)
      {
        document.getElementById("qry_edt").Edit(query);
      }
    }

    function On_Save_Query(query)
    {
      var t = this;

      tb.query.Save(db, query, Update_OK);
      function Update_OK()
      {
        // delete trend data
        if (t.item_elem!=null)
          Update_Query_Item(t.item_elem, query);
        else
          Insert_Query_Item(document.getElementById("query_items"), query);

        document.getElementById("qry_ok").show();
      }
    }

    function Insert_Query_Item(list_elem, query)
    {
      var item_elem;

      item_elem = document.createElement("a");
      Update_Query_Item(item_elem, query)
      item_elem.onclick = On_Edit_Query;

      list_elem.appendChild(item_elem);
    }

    function Update_Query_Item(item_elem, query)
    {
      item_elem.text = query.title;
      item_elem.query = query;
    }

    function On_Update_All()
    {
      tb.trend.Insert_From_Queries(db, Insert_From_Queries_OK);
      function Insert_From_Queries_OK()
      {
        document.getElementById("msg_ok").show();
      }
    }

  </script>
</head>

<body>
  <paper-drawer-panel>

    <paper-header-panel drawer>

      <paper-toolbar>
        <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
        <div>Trend Buddy</div>
      </paper-toolbar>

      <div id="menu_items">
        <a id="add_option">Add Query</a>
        <a id="upd_option">Update All</a>
        <a id="idx_option">Index</a>
      </div>

      <div id="query_items">
      </div>

    </paper-header-panel>

    <paper-header-panel main>

      <paper-toolbar>
        <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
      </paper-toolbar>

      <query-editor id="qry_edt"></query-editor>

    </paper-header-panel>

  </paper-drawer-panel>

  <paper-toast id="msg_ok" text="All trends updated."></paper-toast>
  <paper-toast id="qry_ok" text="Query updated."></paper-toast>
  <paper-toast id="trend_del_ok" text="All trend data deleted."></paper-toast>
  <paper-toast id="del_ok" text="Query deleted."></paper-toast>
  <paper-toast id="msg"></paper-toast>

</body>

</html>